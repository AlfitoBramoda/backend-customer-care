<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Persistence Test</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            max-width: 800px; 
            margin: 0 auto; 
            padding: 20px; 
        }
        .container { 
            display: flex; 
            gap: 20px; 
        }
        .chat-box { 
            flex: 1; 
            border: 1px solid #ccc; 
            height: 400px; 
            overflow-y: auto; 
            padding: 10px; 
            background: #f9f9f9; 
        }
        .input-section { 
            margin-top: 20px; 
        }
        input, select, button { 
            padding: 8px; 
            margin: 5px; 
        }
        .message { 
            margin: 5px 0; 
            padding: 5px; 
            border-radius: 5px; 
        }
        .customer { 
            background: #e3f2fd; 
            text-align: right; 
        }
        .employee { 
            background: #f3e5f5; 
            text-align: left; 
        }
        .system { 
            background: #fffde7; 
            font-style: italic; 
            color: #666; 
        }
        .error { 
            background: #ffebee; 
            color: #c62828; 
        }
        .success { 
            background: #e8f5e8; 
            color: #2e7d32; 
        }
    </style>
</head>
<body>
    <h1>🧪 Chat Persistence Test</h1>
    <div style="background: #f5f5f5; padding: 10px; margin-bottom: 20px; border-radius: 5px;">
        <p><strong>Test Scenario:</strong> Send messages to ticket rooms and verify they're saved to PostgreSQL via REST API</p>
        <p><strong>Backend API:</strong> <span id="backend-url">Loading...</span></p>
        <p><strong>Connection:</strong> <span id="connection-status">Connecting...</span></p>
    </div>

    <div class="container">
        <div>
            <h3>💬 Chat Messages</h3>
            <div id="chat" class="chat-box"></div>
        </div>
        <div>
            <h3>📊 System Logs</h3>
            <div id="logs" class="chat-box"></div>
        </div>
    </div>

    <div class="input-section">
        <h3>Send Test Message</h3>
        <div>
            <select id="userType">
                <option value="CUS-1">Customer (CUS-1)</option>
                <option value="EMP-1">Employee (EMP-1)</option>
            </select>
            
            <select id="roomType">
                <option value="call:ticket-1">Ticket Room (call:ticket-1)</option>
                <option value="call:ticket-32">Ticket Room (call:ticket-32)</option>
                <option value="dm:CUS-1:EMP-1">DM Room (should skip)</option>
            </select>
        </div>
        <div>
            <input type="text" id="messageInput" placeholder="Type your message..." style="width: 60%;">
            <button onclick="sendMessage()">Send Message</button>
        </div>
        <div>
            <button onclick="clearLogs()">Clear Logs</button>
            <button onclick="testConnection()">Test Connection</button>
        </div>
    </div>

    <script>
        const socket = io();
        const chatDiv = document.getElementById('chat');
        const logsDiv = document.getElementById('logs');
        
        // Connection handling
        socket.on('connect', () => {
            document.getElementById('connection-status').textContent = '✅ Connected';
            document.getElementById('connection-status').style.color = 'green';
            addLog('system', '✅ Connected to Socket.IO server');
        });
        
        socket.on('disconnect', () => {
            document.getElementById('connection-status').textContent = '❌ Disconnected';
            document.getElementById('connection-status').style.color = 'red';
            addLog('error', '❌ Disconnected from server');
        });

        // Chat message received
        socket.on('chat:new', (msg) => {
            addMessage('received', `${msg.senderId || 'Unknown'}: ${msg.message || msg.text}`);
        });

        // Chat persistence feedback
        socket.on('chat:ack', (data) => {
            addLog('success', `✅ Message saved to DB: ${JSON.stringify(data, null, 2)}`);
        });

        socket.on('chat:persist_error', (error) => {
            addLog('error', `❌ Save failed: ${JSON.stringify(error, null, 2)}`);
        });

        // Helper functions
        function addMessage(type, text) {
            const div = document.createElement('div');
            div.className = `message ${type}`;
            div.textContent = `[${new Date().toLocaleTimeString()}] ${text}`;
            chatDiv.appendChild(div);
            chatDiv.scrollTop = chatDiv.scrollHeight;
        }

        function addLog(type, text) {
            const div = document.createElement('div');
            div.className = `message ${type}`;
            div.innerHTML = `[${new Date().toLocaleTimeString()}] ${text}`;
            logsDiv.appendChild(div);
            logsDiv.scrollTop = logsDiv.scrollHeight;
        }

        function sendMessage() {
            const userType = document.getElementById('userType').value;
            const roomType = document.getElementById('roomType').value;
            const messageText = document.getElementById('messageInput').value.trim();
            
            if (!messageText) {
                alert('Please enter a message');
                return;
            }

            // Auth as user
            socket.emit('auth:register', { userId: userType });
            
            // Join room
            socket.emit('join', { room: roomType, userId: userType });
            
            // Send message with proper format
            const msgPayload = {
                room: roomType,
                message: messageText,
                senderId: userType,
                senderTypeId: userType.startsWith('EMP-') ? 2 : 1,
                // Explicitly set ticketId for testing
                ticketId: roomType.match(/ticket[-:]?(\d+)/)?.[1] || null
            };

            addMessage('customer', `${userType}: ${messageText}`);
            addLog('system', `📤 Sending: ${JSON.stringify(msgPayload, null, 2)}`);
            
            socket.emit('chat:send', msgPayload);
            
            // Clear input
            document.getElementById('messageInput').value = '';
        }

        function clearLogs() {
            logsDiv.innerHTML = '';
            chatDiv.innerHTML = '';
        }

        function testConnection() {
            addLog('system', '🔄 Testing connection...');
            socket.emit('auth:register', { userId: 'TEST-USER' });
        }

        // Auto-focus message input
        document.getElementById('messageInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        // Set backend URL in UI
        document.getElementById('backend-url').textContent = 'http://localhost:3001 (or configured URL)';
    </script>
</body>
</html>
