<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Persistence Test</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            max-width: 800px; 
            margin: 0 auto; 
            padding: 20px; 
        }
        .container { 
            display: flex; 
            gap: 20px; 
        }
        .chat-box { 
            flex: 1; 
            border: 1px solid #ccc; 
            height: 400px; 
            overflow-y: auto; 
            padding: 10px; 
            background: #f9f9f9; 
        }
        .input-section { 
            margin-top: 20px; 
        }
        input, select, button { 
            padding: 8px; 
            margin: 5px; 
        }
        .message { 
            margin: 5px 0; 
            padding: 5px; 
            border-radius: 5px; 
        }
        .customer { 
            background: #e3f2fd; 
            text-align: right; 
        }
        .employee { 
            background: #f3e5f5; 
            text-align: left; 
        }
        .system { 
            background: #fffde7; 
            font-style: italic; 
            color: #666; 
        }
        .error { 
            background: #ffebee; 
            color: #c62828; 
        }
        .success { 
            background: #e8f5e8; 
            color: #2e7d32; 
        }
    </style>
</head>
<body>
    <h1>üß™ Chat Persistence Test</h1>
    <div style="background: #f5f5f5; padding: 10px; margin-bottom: 20px; border-radius: 5px;">
        <p><strong>Test Scenario:</strong> Send messages to ticket rooms and verify they're saved to PostgreSQL via REST API</p>
        <p><strong>Backend API:</strong> <span id="backend-url">Loading...</span></p>
        <p><strong>Connection:</strong> <span id="connection-status">Connecting...</span></p>
        <p><strong>Auth Status:</strong> <span id="auth-status">Not logged in</span></p>
    </div>

    <!-- Login Section -->
    <div id="login-section" style="background: #fff3cd; padding: 15px; margin-bottom: 20px; border-radius: 5px; border: 1px solid #ffeaa7;">
        <h3>üîê Authentication Required</h3>
        <p>API requires authentication. Please login first:</p>
        <div style="margin: 10px 0;">
            <input type="text" id="loginEmail" placeholder="Email (e.g., employee@bni.com)" style="width: 200px;">
            <input type="password" id="loginPassword" placeholder="Password" style="width: 150px;">
            <button onclick="login()" style="background: #007bff; color: white; border: none; padding: 8px 15px;">Login</button>
        </div>
        <div style="font-size: 12px; color: #666;">
            <strong>Test Credentials:</strong><br>
            Employee: employee@bni.com / password123<br>
            Customer: customer@bni.com / password123
        </div>
    </div>

    <!-- Main Test Area (initially hidden) -->
    <div id="test-area" style="display: none;">

    <div class="container">
        <div>
            <h3>üí¨ Chat Messages</h3>
            <div id="chat" class="chat-box"></div>
        </div>
        <div>
            <h3>üìä System Logs</h3>
            <div id="logs" class="chat-box"></div>
        </div>
    </div>

    <div class="input-section">
        <h3>Send Test Message</h3>
        <div>
            <select id="userType">
                <option value="CUS-1">Customer (CUS-1)</option>
                <option value="EMP-1">Employee (EMP-1)</option>
            </select>
            
            <select id="roomType">
                <option value="call:ticket-1">Ticket Room (call:ticket-1)</option>
                <option value="call:ticket-32">Ticket Room (call:ticket-32)</option>
                <option value="dm:CUS-1:EMP-1">DM Room (should skip)</option>
            </select>
        </div>
        <div>
            <input type="text" id="messageInput" placeholder="Type your message..." style="width: 60%;">
            <button onclick="sendMessage()">Send Message</button>
        </div>
        <div>
            <button onclick="clearLogs()">Clear Logs</button>
            <button onclick="testConnection()">Test Connection</button>
            <button onclick="logout()" style="background: #dc3545; color: white; border: none; padding: 8px 15px;">Logout</button>
        </div>
    </div>

    </div> <!-- Close test-area -->

    <script>
        const socket = io();
        const chatDiv = document.getElementById('chat');
        const logsDiv = document.getElementById('logs');
        let authToken = null;
        let currentUser = null;
        
        // Check for saved auth token
        const savedToken = localStorage.getItem('auth_token');
        const savedUser = localStorage.getItem('current_user');
        if (savedToken && savedUser) {
            authToken = savedToken;
            currentUser = JSON.parse(savedUser);
            showTestArea();
            updateAuthStatus();
        }
        
        // Authentication functions
        async function login() {
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value.trim();
            
            if (!email || !password) {
                alert('Please enter both email and password');
                return;
            }
            
            addLog('system', 'üîÑ Attempting login...');
            
            try {
                const response = await fetch('https://bcare.my.id/v1/auth/login/customer', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ email, password })
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    authToken = data.data.token;
                    currentUser = data.data.user;
                    
                    // Save to localStorage
                    localStorage.setItem('auth_token', authToken);
                    localStorage.setItem('current_user', JSON.stringify(currentUser));
                    
                    addLog('success', `‚úÖ Login successful! Welcome ${currentUser.name || currentUser.email}`);
                    showTestArea();
                    updateAuthStatus();
                } else {
                    addLog('error', `‚ùå Login failed: ${data.message || 'Unknown error'}`);
                }
            } catch (error) {
                addLog('error', `‚ùå Login error: ${error.message}`);
            }
        }
        
        function logout() {
            authToken = null;
            currentUser = null;
            localStorage.removeItem('auth_token');
            localStorage.removeItem('current_user');
            
            document.getElementById('login-section').style.display = 'block';
            document.getElementById('test-area').style.display = 'none';
            document.getElementById('loginEmail').value = '';
            document.getElementById('loginPassword').value = '';
            
            updateAuthStatus();
            addLog('system', 'üö™ Logged out successfully');
        }
        
        function showTestArea() {
            document.getElementById('login-section').style.display = 'none';
            document.getElementById('test-area').style.display = 'block';
        }
        
        function updateAuthStatus() {
            const authStatusEl = document.getElementById('auth-status');
            if (authToken && currentUser) {
                authStatusEl.textContent = `‚úÖ Logged in as ${currentUser.name || currentUser.email}`;
                authStatusEl.style.color = 'green';
            } else {
                authStatusEl.textContent = '‚ùå Not logged in';
                authStatusEl.style.color = 'red';
            }
        }
        
        // Connection handling
        socket.on('connect', () => {
            document.getElementById('connection-status').textContent = '‚úÖ Connected';
            document.getElementById('connection-status').style.color = 'green';
            addLog('system', '‚úÖ Connected to Socket.IO server');
        });
        
        socket.on('disconnect', () => {
            document.getElementById('connection-status').textContent = '‚ùå Disconnected';
            document.getElementById('connection-status').style.color = 'red';
            addLog('error', '‚ùå Disconnected from server');
        });

        // Chat message received
        socket.on('chat:new', (msg) => {
            addMessage('received', `${msg.senderId || 'Unknown'}: ${msg.message || msg.text}`);
        });

        // Chat persistence feedback
        socket.on('chat:ack', (data) => {
            addLog('success', `‚úÖ Message saved to DB: ${JSON.stringify(data, null, 2)}`);
        });

        socket.on('chat:persist_error', (error) => {
            addLog('error', `‚ùå Save failed: ${JSON.stringify(error, null, 2)}`);
        });

        // Helper functions
        function addMessage(type, text) {
            const div = document.createElement('div');
            div.className = `message ${type}`;
            div.textContent = `[${new Date().toLocaleTimeString()}] ${text}`;
            chatDiv.appendChild(div);
            chatDiv.scrollTop = chatDiv.scrollHeight;
        }

        function addLog(type, text) {
            const div = document.createElement('div');
            div.className = `message ${type}`;
            div.innerHTML = `[${new Date().toLocaleTimeString()}] ${text}`;
            logsDiv.appendChild(div);
            logsDiv.scrollTop = logsDiv.scrollHeight;
        }

        function sendMessage() {
            if (!authToken) {
                alert('Please login first');
                return;
            }
            
            const userType = document.getElementById('userType').value;
            const roomType = document.getElementById('roomType').value;
            const messageText = document.getElementById('messageInput').value.trim();
            
            if (!messageText) {
                alert('Please enter a message');
                return;
            }

            // Auth as user
            socket.emit('auth:register', { userId: userType });
            
            // Join room
            socket.emit('join', { room: roomType, userId: userType });
            
            // Send message with proper format and auth token
            const msgPayload = {
                room: roomType,
                message: messageText,
                senderId: userType,
                senderTypeId: userType.startsWith('EMP-') ? 2 : 1,
                // Explicitly set ticketId for testing
                ticketId: roomType.match(/ticket[-:]?(\d+)/)?.[1] || null,
                // Add auth token for API calls
                authToken: authToken
            };

            addMessage('customer', `${userType}: ${messageText}`);
            addLog('system', `üì§ Sending: ${JSON.stringify({...msgPayload, authToken: '***'}, null, 2)}`);
            
            socket.emit('chat:send', msgPayload);
            
            // Clear input
            document.getElementById('messageInput').value = '';
        }

        function clearLogs() {
            logsDiv.innerHTML = '';
            chatDiv.innerHTML = '';
        }

        function testConnection() {
            addLog('system', 'üîÑ Testing connection...');
            socket.emit('auth:register', { userId: 'TEST-USER' });
        }

        // Auto-focus message input
        document.getElementById('messageInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
        
        // Login form enter key support
        document.getElementById('loginEmail').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                document.getElementById('loginPassword').focus();
            }
        });
        
        document.getElementById('loginPassword').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                login();
            }
        });

        // Set backend URL in UI
        document.getElementById('backend-url').textContent = 'https://bcare.my.id (or configured URL)';
        
        // Initialize auth status
        updateAuthStatus();
    </script>
</body>
</html>
